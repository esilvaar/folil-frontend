AWSTemplateFormatVersion: '2010-09-09'
Description: "Frontend Stack: S3, CloudFront & CI/CD (Modernized with CodeStar)"

Parameters:
  EnvironmentName:
    Type: String
    Default: prod
  FrontendBucketName:
    Type: String
    Default: "my-app-frontend-assets"
  GitHubOwner:
    Type: String
    Description: "El nombre de usuario u organización de GitHub"
  GitHubRepo:
    Type: String
    Description: "El nombre del repositorio"
  GitHubBranch:
    Type: String
    Default: "main"
  CodeStarConnectionArn:
    Type: String
    Description: "El ARN de la conexión creada en Configuración de Desarrollador (CodeStar)"
  BackendApiUrl:
    Type: String
    Description: "URL opcional de la API del Backend"
    Default: ""

Resources:

  FrontendBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${EnvironmentName}-${FrontendBucketName}"
      WebsiteConfiguration:
        IndexDocument: index.html
        ErrorDocument: index.html
      PublicAccessBlockConfiguration:
        BlockPublicAcls: false
        BlockPublicPolicy: false
        IgnorePublicAcls: false
        RestrictPublicBuckets: false

  FrontendBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref FrontendBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: PublicReadGetObject
            Effect: Allow
            Principal: "*"
            Action: s3:GetObject
            Resource: !Sub "arn:aws:s3:::${FrontendBucket}/*"

  FrontendCloudFront:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        DefaultRootObject: index.html
        Origins:
          - Id: S3Origin
            DomainName: !GetAtt FrontendBucket.RegionalDomainName
            S3OriginConfig: {}
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods: [GET, HEAD, OPTIONS]
          ForwardedValues:
            QueryString: false
            Cookies: { Forward: none }
        ViewerCertificate:
          CloudFrontDefaultCertificate: true

  PipelineArtifactBucket:
    Type: AWS::S3::Bucket
    Properties:
      VersioningConfiguration: { Status: Enabled }

  CodeBuildRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement: [{Effect: Allow, Principal: {Service: codebuild.amazonaws.com}, Action: sts:AssumeRole}]
      Policies:
        - PolicyName: CodeBuildBasePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "*"
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:GetObjectVersion
                Resource:
                  - !Sub "arn:aws:s3:::${PipelineArtifactBucket}/*"
                  - !Sub "arn:aws:s3:::${FrontendBucket}/*"

  CodePipelineRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement: [{Effect: Allow, Principal: {Service: codepipeline.amazonaws.com}, Action: sts:AssumeRole}]
      Policies:
        - PolicyName: CodePipelineBasePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                  - s3:PutObject
                  - s3:GetBucketVersioning
                Resource:
                  - !Sub "arn:aws:s3:::${PipelineArtifactBucket}"
                  - !Sub "arn:aws:s3:::${PipelineArtifactBucket}/*"
                  - !Sub "arn:aws:s3:::${FrontendBucket}"
                  - !Sub "arn:aws:s3:::${FrontendBucket}/*"
              - Effect: Allow
                Action:
                  - codebuild:BatchGetBuilds
                  - codebuild:StartBuild
                Resource: !GetAtt FrontendBuildProject.Arn
              - Effect: Allow
                Action:
                  - codestar-connections:UseConnection
                Resource: !Ref CodeStarConnectionArn

FrontendBuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub "${EnvironmentName}-frontend-build"
      ServiceRole: !Ref CodeBuildRole
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        # CAMBIO 1: Usar imagen moderna (Standard 7.0) para soportar herramientas nuevas
        Image: aws/codebuild/standard:7.0
        Type: LINUX_CONTAINER
        EnvironmentVariables:
          - Name: VITE_API_URL
            Value: !Ref BackendApiUrl
      Source:
        Type: CODEPIPELINE
        BuildSpec: |
          version: 0.2
          phases:
            install:
              runtime-versions:
                # CAMBIO 2: Usar Node 20 (Requerido por Vite 7 y React 19)
                nodejs: 20
              commands:
                - echo Installing dependencies...
                - npm install
            build:
              commands:
                - echo Building React app...
                - npm run build
                # Comando de depuración para verificar que 'dist' se creó
                - ls -la
          artifacts:
            files:
              - '**/*'
            base-directory: dist
  FrontendPipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      RoleArn: !GetAtt CodePipelineRole.Arn
      ArtifactStore:
        Type: S3
        Location: !Ref PipelineArtifactBucket
      Stages:
        - Name: Source
          Actions:
            - Name: SourceAction
              ActionTypeId: 
                Category: Source
                Owner: AWS 
                Provider: CodeStarSourceConnection
                Version: '1'
              OutputArtifacts: [{ Name: SourceOutput }]
              Configuration:
                ConnectionArn: !Ref CodeStarConnectionArn
                FullRepositoryId: !Sub "${GitHubOwner}/${GitHubRepo}"
                BranchName: !Ref GitHubBranch
                OutputArtifactFormat: CODE_ZIP
        - Name: Build
          Actions:
            - Name: BuildReact
              ActionTypeId: { Category: Build, Owner: AWS, Provider: CodeBuild, Version: '1' }
              InputArtifacts: [{ Name: SourceOutput }]
              OutputArtifacts: [{ Name: BuildOutput }]
              Configuration: { ProjectName: !Ref FrontendBuildProject }
        - Name: Deploy
          Actions:
            - Name: DeployToS3
              ActionTypeId: { Category: Deploy, Owner: AWS, Provider: S3, Version: '1' }
              InputArtifacts: [{ Name: BuildOutput }]
              Configuration:
                BucketName: !Ref FrontendBucket
                Extract: 'true'

Outputs:
  CloudFrontURL:

    Value: !GetAtt FrontendCloudFront.DomainName






